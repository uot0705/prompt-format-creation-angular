<div class="container">
  <div class="left-panel">
    <form>
      <div class="title-content">
        <h3>質問フォーム</h3>
        <label>
          <input
            type="checkbox"
            [checked]="selectedPreset() === 'question'"
            (click)="onPresetClick('question')"
          />
          質問
        </label>
        <label>
          <input
            type="checkbox"
            [checked]="selectedPreset() === 'error'"
            (click)="onPresetClick('error')"
          />
          エラー相談
        </label>
        <label>
          <input
            type="checkbox"
            [checked]="selectedPreset() === 'variableName'"
            (click)="onPresetClick('variableName')"
          />
          変数名の提案
        </label>
        <label>
          <input
            type="checkbox"
            [checked]="selectedPreset() === 'refactor'"
            (click)="onPresetClick('refactor')"
          />
          リファクタ
        </label>
        <label>
          <input
            type="checkbox"
            [checked]="selectedPreset() === 'review'"
            (click)="onPresetClick('review')"
          />
          レビュー指摘
        </label>
        <label>
          <input
            type="checkbox"
            [checked]="selectedPreset() === 'organize'"
            (click)="onPresetClick('organize')"
          />
          やりとり整理
        </label>
        <label>
          <input
            type="checkbox"
            [checked]="selectedPreset() === 'analyze'"
            (click)="onPresetClick('analyze')"
          />
          コード分析
        </label>
      </div>

      <textarea
        id="main-question"
        name="mainQuestion"
        rows="8"
        [ngModel]="mainQuestion()"
        (ngModelChange)="mainQuestion.set($event)"
      ></textarea>

      <div id="fields-container">
        @for (field of fields(); track field.id) {
        <div class="field">
          <div class="field-header">
            <button
              class="toggle-btn"
              type="button"
              [class.active]="field.expanded"
              (click)="toggleField(field)"
            >
              {{ field.expanded ? "▲" : "▼" }}
            </button>
            <input
              class="title-input"
              [value]="field.title"
              (input)="handleFieldChange($event, field.id, 'title')"
              name="field-title"
              type="text"
              placeholder="タイトル"
            />
            <div class="header-buttons">
              <button type="button" (click)="moveFieldUp(field)">▲</button>
              <button type="button" (click)="moveFieldDown(field)">▼</button>
              <button
                type="button"
                (click)="removeField(field)"
                class="delete-btn"
              >
                削除
              </button>
            </div>
          </div>

          <div class="common-words-content">
            <div class="common-words-group common-words-general">
              <button
                type="button"
                (click)="setCommonTitleWord(field.id, '出力内容')"
              >
                出力内容
              </button>
              <button
                type="button"
                (click)="setCommonTitleWord(field.id, 'コード')"
              >
                コード
              </button>
              <button
                type="button"
                (click)="setCommonTitleWord(field.id, 'エラー内容')"
              >
                エラー内容
              </button>
            </div>
            <div class="common-words-group common-words-file">
              <button
                type="button"
                (click)="setCommonTitleWord(field.id, 'TSファイル')"
              >
                TSファイル
              </button>
              <button
                type="button"
                (click)="setCommonTitleWord(field.id, 'HTMLファイル')"
              >
                HTMLファイル
              </button>
              <button
                type="button"
                (click)="setCommonTitleWord(field.id, 'CSSファイル')"
              >
                CSSファイル
              </button>
            </div>
          </div>

          @if (field.expanded) {
          <div class="field-content">
            <textarea
              class="field-content-textarea"
              [value]="field.content"
              (input)="handleFieldChange($event, field.id, 'content')"
              name="field-content"
              rows="8"
              placeholder="内容"
            ></textarea>
          </div>
          }
        </div>
        }
      </div>

      <button id="add-field-btn" type="button" (click)="addField()">
        追加
      </button>
    </form>
  </div>

  <div class="right-panel">
    <div class="copy-actions">
      <button
        id="copy-btn"
        (click)="copyToClipboard()"
        class="copy-btn"
        [class.success]="copySuccess()"
      >
        {{ copySuccess() ? "コピペ成功" : "コピペ" }}
      </button>
      <button id="history-btn" type="button" (click)="openHistoryModal()">
        履歴
      </button>
    </div>
    <div id="output">
      <div id="main-question-output" [innerHTML]="mainQuestionOutput()"></div>
      <div id="fields-output" [innerHTML]="fieldsOutputForDisplay()"></div>
    </div>
  </div>

  <button
    id="fixed-copy-btn"
    (click)="copyToClipboard()"
    class="fixed-copy-btn"
    [class.success]="copySuccess()"
  >
    {{ copySuccess() ? "コピペ成功" : "コピペ" }}
  </button>

  @if (historyOpen()) {
  <div class="history-overlay" (click)="closeHistoryModal()">
    <div class="history-modal" (click)="$event.stopPropagation()">
      <div class="history-modal-header">
        <h4>履歴</h4>
        <button
          type="button"
          class="history-close-btn"
          (click)="closeHistoryModal()"
        >
          ×
        </button>
      </div>
      <div class="history-list">
        @if (historyItems().length === 0) {
        <div class="history-empty">履歴はまだありません</div>
        } @else {
        @for (item of historyItems(); track item.text) {
        <button
          type="button"
          class="history-item"
          (mouseenter)="showHistoryPreview(item, $event)"
          (mouseleave)="hideHistoryPreview()"
          (click)="applyHistory(item)"
        >
          {{ formatHistoryLabel(item) }}
        </button>
        }
        }
      </div>
    </div>
    @if (historyPreview()) {
    <div
      class="history-preview-tooltip"
      [style.top.px]="historyPreview()!.top"
      [style.left.px]="historyPreview()!.left"
    >
      {{ historyPreview()!.text }}
    </div>
    }
  </div>
  }
</div>
